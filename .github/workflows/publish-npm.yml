name: Publish npm Package

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-publish:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            code-target: darwin-arm64
          - target: x86_64-apple-darwin
            os: macos-latest
            code-target: darwin-x64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-arm64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-x64
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            code-target: win32-arm64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            code-target: win32-x64

    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross --locked

      - name: Build ${{ matrix.target }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Verify binary
        id: verify-binary
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/pr-note${{ (matrix.target == 'x86_64-pc-windows-msvc' || matrix.target == 'aarch64-pc-windows-msvc') && '.exe' || '' }}"

          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi

          ls -la "$BINARY_PATH"
          echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT

      - name: Prepare ${{ matrix.code-target }}
        id: prepare-package
        shell: bash
        run: |
          TARGET_DIR="dist/${{ matrix.code-target }}"

          mkdir -p ${TARGET_DIR}
          cp -r packages/@pr-note/pr-note-${{ matrix.code-target }}/* ${TARGET_DIR}

          BINARY_PATH="${{ steps.verify-binary.outputs.binary_path }}"
          cp ${BINARY_PATH} ${TARGET_DIR}

          ls -la ${TARGET_DIR}
          echo "target_dir=${TARGET_DIR}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: dist/${{ matrix.code-target }}/package.json

      - name: Dry run publish ${{ matrix.code-target }} package
        working-directory: ${{ steps.prepare-package.outputs.target_dir }}
        shell: bash
        run: npm publish --access public --dry-run

      - name: Pack npm package
        working-directory: ${{ steps.prepare-package.outputs.target_dir }}
        shell: bash
        run: |
          npm pack
          ls -la

      - name: Upload built package artifact
        uses: actions/upload-artifact@v5
        with:
          name: pr-note-${{ matrix.code-target }}
          path: ${{ steps.prepare-package.outputs.target_dir }}/*.tgz
          retention-days: 1

  publish-pr-note:
    name: Publish @pr-note/pr-note
    needs: build-and-publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download all built artifacts
        uses: actions/download-artifact@v5
        with:
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: packages/@pr-note/pr-note/package.json

      - name: Verify main package
        id: verify-main-package
        shell: bash
        run: |
          PACKAGE_DIR="packages/@pr-note/pr-note"

          if [ ! -d ${PACKAGE_DIR} ]; then
            echo "${PACKAGE_DIR} not found"
            exit 1
          fi

          ls -la ${PACKAGE_DIR}
          echo "package_dir=${PACKAGE_DIR}" >> $GITHUB_OUTPUT

      - name: Install platform packages locally
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        shell: bash
        run: find ../../.. -name "*.tgz" -type f -print0 | xargs -0 -I{} npm install {}

      # TODO: Debug!!!
      - name: Debug CLI files
        run: |
          cd packages/@pr-note/pr-note
          echo "Current dir: $(pwd)"
          echo "--- List files ---"
          ls -R .
          echo "--- Node version ---"
          node -v
          echo "--- Which pr-note ---"
          which pr-note || true
          echo "--- Check node_modules/.bin ---"
          ls node_modules/.bin || true

      - name: Link main package (generate .bin)
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        run: |
          ls -R node_modules
          npm pack
          npm install ./$(npm pack | tail -n1)
          echo "--- Check node_modules/.bin ---"
          ls -R node_modules

      - name: Run local test
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        shell: bash
        run: |
          echo "Running CLI..."
          set +e
          npx pr-note --help
          echo "Exit code: $?"
          node bin/cli.mjs --help 2>&1 | tee cli.log
          echo "Exit code: $?"

      - name: Dry run publish main package
        shell: bash
        run: |
          cd ${{ steps.verify-main-package.outputs.package_dir }}
          npm publish --access public --dry-run
