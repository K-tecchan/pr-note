name: Publish npm Package

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-publish:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            code-target: darwin-arm64
            archive: pr-note-darwin-arm64.tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            code-target: darwin-x64
            archive: pr-note-darwin-x64.tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-arm64
            archive: pr-note-linux-arm64.tar.gz
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-x64
            archive: pr-note-linux-x64.tar.gz
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            code-target: win32-arm64
            archive: pr-note-win32-arm64.zip
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            code-target: win32-x64
            archive: pr-note-win32-x64.zip

    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross --locked

      - name: Build ${{ matrix.target }}
        run: cross build --release --target ${{ matrix.target }}

      ########################################
      #   .                                  #
      #   ≈                                  #
      #   └── target                         #
      #        └── {{ matrix.target }}       #
      #             └── release              #
      #                  └── pr-note(.exe)   #
      #                                      #
      ########################################
      - name: Verify binary
        id: verify-binary
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/pr-note${{ contains(matrix.target, 'windows') && '.exe' || '' }}"

          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi

          ls -la "$BINARY_PATH"
          echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT

      ########################################
      #   .                                  #
      #   ≈                                  #
      #   └── target                         #
      #        └── {{ matrix.target }}       #
      #             └── release              #
      #                  └── pr-note(.exe)   #
      #                                      #
      ########################################
      - name: Place binary in the dist/${{ matrix.code-target }}
        id: place-binary
        shell: bash
        run: |
          TARGET_DIR="dist/${{ matrix.code-target }}"

          mkdir -p ${TARGET_DIR}
          cp -r packages/@pr-note/pr-note-${{ matrix.code-target }}/* ${TARGET_DIR}

          BINARY_PATH="${{ steps.verify-binary.outputs.binary_path }}"
          cp ${BINARY_PATH} ${TARGET_DIR}

          ls -la ${TARGET_DIR}
          echo "target_dir=${TARGET_DIR}" >> $GITHUB_OUTPUT

      ########################################
      #   .                                  #
      #   ≈                                  #
      #   ├── target                         #
      #   │    └── {{ matrix.target }}       #
      #   │         └── release              #
      #   │              └── pr-note(.exe)   #
      #   └── dist                           #
      #        └── {{ matrix.code-target }}  #
      #             ├── package.json         #
      #             └── pr-note(.exe)        #
      #                                      #
      ########################################
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: dist/${{ matrix.code-target }}/package.json

      ##################################################
      #   .                                            #
      #   ≈                                            #
      #   └── dist                                     #
      #        └── {{ matrix.code-target }}            #
      #             ├── package.json                   #
      #             └── pr-note(.exe)                  #
      #                                                #
      ##################################################
      - name: Dry run "publish ${{ matrix.code-target }} npm package"
        working-directory: ${{ steps.place-binary.outputs.target_dir }}
        shell: bash
        run: npm publish --access public --dry-run

      ##################################################
      #   .                                            #
      #   ≈                                            #
      #   └── dist                                     #
      #        └── {{ matrix.code-target }}(*)         #
      #             ├── package.json                   #
      #             └── pr-note(.exe)                  #
      #                                                #
      ##################################################
      - name: Pack ${{ matrix.code-target }} npm package for test main package
        working-directory: ${{ steps.place-binary.outputs.target_dir }}
        shell: bash
        run: |
          npm pack
          ls -la

      ################################################################################
      #   .                                                                          #
      #   ≈                                                                          #
      #   └── dist                                                                   #
      #        └── {{ matrix.code-target }}                                          #
      #             ├── package.json                                                 #
      #             ├── pr-note(.exe)                                                #
      #             └── pr-note-pr-note-{{ matrix.code-target }}-{{ ver }}.tgz       #
      #                                                                              #
      ################################################################################
      - name: Upload built package artifact
        uses: actions/upload-artifact@v5
        with:
          name: pr-note-${{ matrix.code-target }}
          path: ${{ steps.place-binary.outputs.target_dir }}/*.tgz
          retention-days: 1

      - name: package binary for homebrew
        run: |
          mkdir -p brew
          ARCHIVE_NAME=${{ matrix.archive }}
          BINARY_PATH="${{ steps.verify-binary.outputs.binary_path }}"

          if [[ "$ARCHIVE_NAME" == *.zip ]]; then
            zip -j "brew/$ARCHIVE_NAME" "$BINARY_PATH"
          else
            tar -czvf "brew/$ARCHIVE_NAME" -C "$(dirname "$BINARY_PATH")" "$(basename "$BINARY_PATH")"
          fi

          ls -la brew/

      - name: Upload to GitHub Release
        if: startsWith(github.ref_name, 'v')
        uses: softprops/action-gh-release@v2
        with:
          files: brew/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pr-note:
    name: Publish @pr-note/pr-note
    needs: build-and-publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download all built artifacts
        uses: actions/download-artifact@v5
        with:
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: packages/@pr-note/pr-note/package.json

      ########################################
      #   .                                  #
      #   ≈                                  #
      #   └── packages                       #
      #        └── @pr-note                  #
      #             └── pr-note              #
      #                  ├── bin             #
      #                  │    └── cli.mjs    #
      #                  ├── package.json    #
      #                  └── README.md       #
      #                                      #
      ########################################
      - name: Verify main package
        id: verify-main-package
        shell: bash
        run: |
          PACKAGE_DIR="packages/@pr-note/pr-note"

          if [ ! -d ${PACKAGE_DIR} ]; then
            echo "${PACKAGE_DIR} not found"
            exit 1
          fi

          ls -la ${PACKAGE_DIR}
          echo "package_dir=${PACKAGE_DIR}" >> $GITHUB_OUTPUT

      ################################################################################
      #   .                                                                          #
      #   ≈                                                                          #
      #   ├── packages                                                               #
      #   │     └── @pr-note                                                         #
      #   │          └── pr-note(*)                                                  #
      #   │               ├── bin                                                    #
      #   │               │    └── cli.mjs                                           #
      #   │               ├── package.json                                           #
      #   │               └── README.md                                              #
      #   └── dist                                                                   #
      #        └── {{ matrix.code-target }}                                          #
      #             ├── package.json                                                 #
      #             ├── pr-note(.exe)                                                #
      #             └── pr-note-pr-note-{{ matrix.code-target }}-{{ ver }}.tgz       #
      #                                                                              #
      ################################################################################
      - name: Install platform packages locally
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        shell: bash
        run: find ../../.. -name "*.tgz" -type f -print0 | xargs -0 -I{} npm install {}

      # TODO: Debug!!!
      - name: Debug CLI files
        run: |
          cd packages/@pr-note/pr-note
          echo "Current dir: $(pwd)"
          echo "--- List files ---"
          ls -R .
          echo "--- Node version ---"
          node -v
          echo "--- Which pr-note ---"
          which pr-note || true
          echo "--- Check node_modules/.bin ---"
          ls node_modules/.bin || true

      ################################################################################
      #   .                                                                          #
      #   ≈                                                                          #
      #   └── packages                                                               #
      #         └── @pr-note                                                         #
      #              └── pr-note(*)                                                  #
      #                   ├── bin                                                    #
      #                   │    └── cli.mjs                                           #
      #                   ├── package.json                                           #
      #                   ├── README.md                                              #
      #                   └── node_modules                                           #
      #                        └── @pr-note                                          #
      #                             └── pr-note-{{ matrix.code-target }}             #
      #                                  ├── pr-note(.exe)                           #
      #                                  └── package.json                            #
      #                                                                              #
      ################################################################################
      - name: Link main package (generate .bin)
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        run: |
          ls -R node_modules
          npm pack
          npm install ./$(npm pack | tail -n1)
          echo "--- Check node_modules/.bin ---"
          ls -R node_modules

      ################################################################################
      #   .                                                                          #
      #   ≈                                                                          #
      #   └── packages                                                               #
      #         └── @pr-note                                                         #
      #              └── pr-note(*)                                                  #
      #                   ├── bin                                                    #
      #                   │    └── cli.mjs                                           #
      #                   ├── package.json                                           #
      #                   ├── README.md                                              #
      #                   └── node_modules                                           #
      #                        └── @pr-note                                          #
      #                             ├── pr-note-{{ matrix.code-target }}             #
      #                             │      ├── pr-note(.exe)                         #
      #                             │      └── package.json                          #
      #                             └── pr-note                                      #
      #                                  ├── README.md                               #
      #                                  ├── bin                                     #
      #                                  │    └── cli.mjs                            #
      #                                  └── package.json                            #
      #                                                                              #
      ################################################################################
      - name: Run local test
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        shell: bash
        run: |
          echo "Running CLI..."
          set +e
          npx pr-note --help
          echo "Exit code: $?"
          node bin/cli.mjs --help 2>&1 | tee cli.log
          echo "Exit code: $?"

      - name: Dry run publish main package
        working-directory: ${{ steps.verify-main-package.outputs.package_dir }}
        shell: bash
        run: npm publish --access public --dry-run

  # update-homebrew:
  #   name: Update Homebrew Tap
  #   needs: build-and-publish
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout tap repo
  #       uses: actions/checkout@v5
  #       with:
  #         repository: yourname/homebrew-tap
  #         token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
  #         path: homebrew-tap

  #     - name: Download release assets
  #       uses: actions/github-script@v7
  #       id: get-assets
  #       with:
  #         script: |
  #           const {owner, repo} = context.repo;
  #           const release = await github.rest.repos.getReleaseByTag({
  #             owner,
  #             repo,
  #             tag: context.ref.replace("refs/tags/", "")
  #           });
  #           return release.data.assets.map(a => ({
  #             name: a.name,
  #             url: a.browser_download_url
  #           }));

  #     - name: Download and calculate SHA256
  #       id: sha256
  #       run: |
  #         mkdir -p assets
  #         for asset in $(echo '${{ steps.get-assets.outputs.result }}' | jq -r '.[].url'); do
  #           fname=$(basename "$asset")
  #           curl -L "$asset" -o "assets/$fname"
  #         done

  #         echo "--- Calculating SHA256 ---"
  #         for f in assets/*.tar.gz; do
  #           sum=$(shasum -a 256 "$f" | cut -d' ' -f1)
  #           echo "$f -> $sum"
  #           echo "$(basename $f)=$sum" >> sha256.txt
  #         done
  #         cat sha256.txt

  #     - name: Generate Homebrew formula
  #       run: |
  #         VERSION=${GITHUB_REF#refs/tags/v}
  #         SHA_DARWIN_X64=$(grep darwin-x64 sha256.txt | cut -d= -f2)
  #         SHA_DARWIN_ARM64=$(grep darwin-arm64 sha256.txt | cut -d= -f2)
  #         SHA_LINUX_X64=$(grep linux-x64 sha256.txt | cut -d= -f2)
  #         SHA_LINUX_ARM64=$(grep linux-arm64 sha256.txt | cut -d= -f2)

  #         cat > homebrew-tap/Formula/pr-note.rb <<'RUBY'
  #         class PrNote < Formula
  #           desc "A CLI tool to generate PR release notes"
  #           homepage "https://github.com/yourname/pr-note"
  #           version "VERSION_PLACEHOLDER"

  #           on_macos do
  #             if Hardware::CPU.arm?
  #               url "https://github.com/yourname/pr-note/releases/download/vVERSION_PLACEHOLDER/pr-note-vVERSION_PLACEHOLDER-darwin-arm64.tar.gz"
  #               sha256 "SHA_DARWIN_ARM64_PLACEHOLDER"
  #             else
  #               url "https://github.com/yourname/pr-note/releases/download/vVERSION_PLACEHOLDER/pr-note-vVERSION_PLACEHOLDER-darwin-x64.tar.gz"
  #               sha256 "SHA_DARWIN_X64_PLACEHOLDER"
  #             end
  #           end

  #           on_linux do
  #             if Hardware::CPU.arm?
  #               url "https://github.com/yourname/pr-note/releases/download/vVERSION_PLACEHOLDER/pr-note-vVERSION_PLACEHOLDER-linux-arm64.tar.gz"
  #               sha256 "SHA_LINUX_ARM64_PLACEHOLDER"
  #             else
  #               url "https://github.com/yourname/pr-note/releases/download/vVERSION_PLACEHOLDER/pr-note-vVERSION_PLACEHOLDER-linux-x64.tar.gz"
  #               sha256 "SHA_LINUX_X64_PLACEHOLDER"
  #             end
  #           end

  #           def install
  #             bin.install "pr-note"
  #           end
  #         end
  #         RUBY

  #         sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" homebrew-tap/Formula/pr-note.rb
  #         sed -i "s/SHA_DARWIN_X64_PLACEHOLDER/$SHA_DARWIN_X64/g" homebrew-tap/Formula/pr-note.rb
  #         sed -i "s/SHA_DARWIN_ARM64_PLACEHOLDER/$SHA_DARWIN_ARM64/g" homebrew-tap/Formula/pr-note.rb
  #         sed -i "s/SHA_LINUX_X64_PLACEHOLDER/$SHA_LINUX_X64/g" homebrew-tap/Formula/pr-note.rb
  #         sed -i "s/SHA_LINUX_ARM64_PLACEHOLDER/$SHA_LINUX_ARM64/g" homebrew-tap/Formula/pr-note.rb

  #     - name: Commit and push formula
  #       working-directory: homebrew-tap
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #         git add Formula/pr-note.rb
  #         git commit -m "update: pr-note to version ${GITHUB_REF#refs/tags/}"
  #         git push
