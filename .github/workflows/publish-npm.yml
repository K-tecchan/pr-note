name: Publish NPM Package

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-publish:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            code-target: darwin-arm64
          - target: x86_64-apple-darwin
            os: macos-latest
            code-target: darwin-x64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-arm64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            code-target: linux-x64
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            code-target: win32-arm64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            code-target: win32-x64

    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross --locked

      - name: Build ${{ matrix.target }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Verify binary
        id: verify-binary
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/pr-note${{ (matrix.target == 'x86_64-pc-windows-msvc' || matrix.target == 'aarch64-pc-windows-msvc') && '.exe' || '' }}"

          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi

          ls -la "$BINARY_PATH"
          echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT

      - name: Prepare ${{ matrix.code-target }}
        id: prepare-package
        shell: bash
        run: |
          TARGET_DIR="dist/${{ matrix.code-target }}"

          mkdir -p ${TARGET_DIR}
          cp -r packages/@pr-note/pr-note${{ matrix.code-target }}/* ${TARGET_DIR}

          BINARY_PATH="${{ steps.verify-binary.outputs.binary_path }}"
          cp ${BINARY_PATH} ${TARGET_DIR}

          tree -a ${TARGET_DIR}
          echo "target_dir=${TARGET_DIR}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: dist/${{ matrix.code-target }}/package.json

      - name: Dry run publish ${{ matrix.code-target }} package
        shell: bash
        run: |
          cd ${{ steps.prepare-package.outputs.target_dir }}
          npm publish --access public --dry-run
